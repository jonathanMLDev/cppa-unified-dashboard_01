sequenceDiagram
    autonumber
    participant FE as Frontend
    participant IPFS as IPFS Service
    participant DB as Database
    participant Admin as Admin Wallet
    participant Sol as Token Contract<br/>(with vault functionality)
    participant Mail as Mailing Service
    participant User as User (with email)
    participant Claim as Claim Service
    participant Wallet as User Wallet

    FE->>IPFS: Submit user + badge payload
    IPFS-->>FE: Return URI + CID metadata
    FE->>DB: Persist issuance record (user data, URI, flags)
    Admin->>FE: Initiate mint (via frontend with admin wallet)
    FE->>Admin: Request transaction signing (token IDs, URI, wallet)
    Admin->>FE: Sign mint or batch mint transaction
    FE->>Sol: Send mint transaction
    Sol-->>Wallet: Mint badge to user wallet (if provided)
    Sol-->>Sol: Store badge in contract (no wallet address)
    Sol-->>DB: Emit confirmation event (tx signatures)

    Sol-->>Mail: Trigger notification payload (wallet vs stored in contract)
    Mail-->>User: Send email (direct badge info or claim instructions)

    Note over Claim,DB: Claim service fetches record using URI<br/>and retrieves registered email address

    User->>FE: Initiate claim request (via frontend)
    FE->>Claim: Request verification code
    Claim->>DB: Generate & store one-time verification code (email, URI, timestamp, expiry)
    Claim->>Mail: Send verification code to mailing service
    Mail-->>User: Send one-time verification code
    User->>FE: Input verification code
    FE->>Claim: Submit verification code
    Claim->>DB: Retrieve stored code & validate (code, rate limits, eligibility)
    Claim->>FE: Prompt for public wallet address
    FE->>User: Display wallet address input
    User->>FE: Provide new wallet address
    FE->>Claim: Submit wallet address
    Claim->>DB: Update claim intent, log timestamp
    Claim->>Mail: Send claim request email to admin
    Mail-->>Admin: Notify admin of claim request (URI, token ID, wallet)
    Admin->>FE: Initiate transfer (via frontend with admin wallet)
    FE->>Admin: Request transaction signing (from contract to wallet)
    Admin->>FE: Sign transfer transaction
    FE->>Sol: Send transfer transaction
    Sol-->>Wallet: Deliver claimed badge to user wallet
    Sol-->>DB: Record claim completion (tx signature, wallet)
    Mail-->>User: Send claim confirmation email

    Note over DB: Maintain full lifecycle history<br/>(metadata hash, issuance, claim attempts, completion)

